<div class="tool-edit-container">
  <!-- Loading spinner -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading tool...</p>
    </div>
  }

  <!-- Not found error -->
  @if (notFound()) {
    <div class="error-container">
      <h1>Error 404</h1>
      <p>Tool not found.</p>
      <button mat-raised-button color="primary" routerLink="/search">
        <mat-icon>search</mat-icon>
        Back to Search
      </button>
    </div>
  }

  <!-- Permission denied -->
  @if (!loading() && !notFound() && !canEditTool() && !isCreateMode()) {
    <div class="permission-denied">
      <div class="permission-content">
        <h1>You don't have permissions to update this resource</h1>
        <button mat-raised-button color="primary" [routerLink]="['/tool', software()?.biotoolsID]">
          <mat-icon>visibility</mat-icon>
          View Tool
        </button>
      </div>
    </div>
  }

  <!-- Main edit interface -->
  <div class="edit-container">
    
    <!-- Header -->
    <div class="edit-header">
      <div class="header-left">
        <h1>{{ pageTitle() }}</h1>
      </div>
      <div class="header-right">
        <div class="action-buttons">
          <!-- Success indicator -->
          @if (registrationSuccess()) {
            <span class="success-indicator">
              <mat-icon>check_circle</mat-icon>
              Success
            </span>
          }

          <!-- Delete button -->
          @if (!isCreateMode()) {
            <button mat-raised-button 
                    color="warn"
                    [disabled]="deletingProgress().inProgress"
                    (click)="onDeleteClick()">
              @if (!deletingProgress().inProgress && !deletingProgress().success && !deletingProgress().error) {
                <mat-icon>delete</mat-icon>
              }
              @if (deletingProgress().inProgress) {
                <mat-spinner diameter="20"></mat-spinner>
              }
              @if (deletingProgress().success) {
                <mat-icon color="accent">check</mat-icon>
              }
              @if (deletingProgress().error) {
                <mat-icon color="warn">close</mat-icon>
              }
              Remove
            </button>
          }

          <!-- Validate button -->
          <button mat-raised-button 
                  color="accent"
                  [disabled]="validationProgress().inProgress"
                  [class.error-border]="validationProgress().error"
                  (click)="onValidateClick()">
            @if (!validationProgress().inProgress && !validationProgress().success && !validationProgress().error) {
              <mat-icon>check_circle_outline</mat-icon>
            }
            @if (validationProgress().inProgress) {
              <mat-spinner diameter="20"></mat-spinner>
            }
            @if (validationProgress().success) {
              <mat-icon color="accent">check</mat-icon>
            }
            @if (validationProgress().error) {
              <mat-icon color="warn">close</mat-icon>
            }
            Validate
          </button>

          <!-- Save button -->
          <button mat-raised-button 
                  color="primary"
                  [disabled]="savingProgress().inProgress"
                  [class.error-border]="savingProgress().error"
                  (click)="onSaveClick()">
            @if (!savingProgress().inProgress && !savingProgress().success && !savingProgress().error) {
              <mat-icon>save</mat-icon>
            }
            @if (savingProgress().inProgress) {
              <mat-spinner diameter="20"></mat-spinner>
            }
            @if (savingProgress().success) {
              <mat-icon color="accent">check</mat-icon>
            }
            @if (savingProgress().error) {
              <mat-icon color="warn">close</mat-icon>
            }
            Save
          </button>

          <!-- Go to entry button -->
          @if (!isCreateMode() && software()?.biotoolsID) {
            <button mat-raised-button 
                    color="primary"
                    [disabled]="savingProgress().inProgress || validationProgress().inProgress || deletingProgress().inProgress"
                    (click)="onGoToEntry()">
              <mat-icon>visibility</mat-icon>
              Go to entry
            </button>
          }
        </div>
      </div>
    </div>

    <!-- Validation errors alert -->
    @if (registrationErrorPayload()) {
      <div class="validation-errors">
        <mat-icon color="warn">error</mat-icon>
        <span>There are validation errors: please fix values shown in red. See the JSON tab for a list of all errors.</span>
      </div>
    }

    <!-- Tab interface -->
    <mat-tab-group class="edit-tabs" dynamicHeight="true">
      
      <!-- Summary tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span [class.tab-error]="hasTabErrors('summary')">Summary</span>
          <span class="required-indicator"> *</span>
        </ng-template>
        <app-tool-edit-summary 
          [tool]="software()" 
          [form]="summaryForm"
          [errors]="registrationErrorPayload()">
        </app-tool-edit-summary>
      </mat-tab>

      <!-- Function tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span [class.tab-error]="hasTabErrors('function')">Function</span>
        </ng-template>
        <app-tool-edit-function 
          [tool]="software()" 
          [form]="functionForm"
          [errors]="registrationErrorPayload()">
        </app-tool-edit-function>
      </mat-tab>

      <!-- Labels tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span [class.tab-error]="hasTabErrors('labels')">Labels</span>
        </ng-template>
        <app-tool-edit-labels 
          [tool]="software()" 
          [form]="labelsForm"
          [errors]="registrationErrorPayload()">
        </app-tool-edit-labels>
      </mat-tab>

      <!-- Links tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span [class.tab-error]="hasTabErrors('links')">Links</span>
        </ng-template>
        <app-tool-edit-links 
          [tool]="software()" 
          [form]="linksForm"
          [errors]="registrationErrorPayload()">
        </app-tool-edit-links>
      </mat-tab>

      <!-- Download tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span [class.tab-error]="hasTabErrors('download')">Download</span>
        </ng-template>
        <app-tool-edit-download 
          [tool]="software()" 
          [form]="downloadForm"
          [errors]="registrationErrorPayload()">
        </app-tool-edit-download>
      </mat-tab>

      <!-- Documentation tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span [class.tab-error]="hasTabErrors('documentation')">Documentation</span>
        </ng-template>
        <app-tool-edit-documentation 
          [tool]="software()" 
          [form]="documentationForm"
          [errors]="registrationErrorPayload()">
        </app-tool-edit-documentation>
      </mat-tab>

      <!-- Publications tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span [class.tab-error]="hasTabErrors('publications')">Publications</span>
        </ng-template>
        <app-tool-edit-publications 
          [tool]="software()" 
          [form]="publicationsForm"
          [errors]="registrationErrorPayload()">
        </app-tool-edit-publications>
      </mat-tab>

      <!-- Credits & Support tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span [class.tab-error]="hasTabErrors('credits')">Credits & Support</span>
        </ng-template>
        <app-tool-edit-credits 
          [tool]="software()" 
          [form]="creditsForm"
          [errors]="registrationErrorPayload()">
        </app-tool-edit-credits>
      </mat-tab>

      <!-- Relations tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span [class.tab-error]="hasTabErrors('relations')">Relations</span>
        </ng-template>
        <app-tool-edit-relations 
          [tool]="software()" 
          [form]="relationsForm"
          [errors]="registrationErrorPayload()">
        </app-tool-edit-relations>
      </mat-tab>

      <!-- JSON tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span [class.tab-error]="hasTabErrors('json')">JSON</span>
        </ng-template>
        <app-tool-edit-json 
          [tool]="software()" 
          [form]="jsonForm"
          [errors]="registrationErrorPayload()">
        </app-tool-edit-json>
      </mat-tab>

      <!-- Permissions tab (only for owners/superusers) -->
      @if (showPermissionsTab()) {
        <mat-tab>
          <ng-template mat-tab-label>
            <span>Permissions</span>
          </ng-template>
          <app-tool-edit-permissions 
            [tool]="software()"
            [currentUser]="currentUser()">
          </app-tool-edit-permissions>
        </mat-tab>
      }

    </mat-tab-group>
  </div>
</div>
